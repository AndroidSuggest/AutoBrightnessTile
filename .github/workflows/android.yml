name: Build and Release APK (No Gradle) with Kotlin

on:
  push:
    branches:
      - main  # Trigger on push to the main branch
  pull_request:
    branches:
      - main  # Trigger on pull request to the main branch

jobs:
  build:
    runs-on: ubuntu-latest # Use the latest Ubuntu image provided by GitHub Actions

    permissions:
      contents: write

    steps:
      # Step 1: Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v6

      # Step 2: Set up the latest Temurin JDK (latest stable version)
      - name: Set up Temurin JDK (latest version)
        uses: actions/setup-java@v5
        with:
          java-version: '25'  # Automatically fetch the latest stable Java version
          distribution: 'temurin'  # Use Adoptium Temurin distribution

      # Step 3: Install Kotlin Compiler
      - name: Install Kotlin Compiler
        run: |
          wget -q https://github.com/JetBrains/kotlin/releases/download/v2.3.0/kotlin-compiler-2.3.0.zip
          unzip  kotlin-compiler-2.3.0.zip -d $HOME/kotlin

      # Step 4: Install Android SDK
      - name: Install Android SDK
        run: |
          sudo apt update
          sudo apt install -y wget unzip
          wget https://dl.google.com/android/repository/commandlinetools-linux-13114758_latest.zip -O commandlinetools.zip
          unzip commandlinetools.zip -d $HOME/android-sdk
          rm commandlinetools.zip
          yes | $HOME/android-sdk/cmdline-tools/bin/sdkmanager --sdk_root=$HOME/android-sdk --update
          yes | $HOME/android-sdk/cmdline-tools/bin/sdkmanager --sdk_root=$HOME/android-sdk "platform-tools" "build-tools;34.0.0" "platforms;android-34"

      # Step 5: Build the APK (Release Mode)
      - name: Build Release APK using Android SDK tools
        run: |
          # Set environment variables
          export ANDROID_HOME=$HOME/android-sdk
          export PATH=$ANDROID_HOME/cmdline-tools/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/34.0.0:$PATH

          # Create the output directory if it does not exist
          mkdir -p build/res

          # https://eab.2bab.com/doc/01/1-4-Build-An-Apk-Manually

          # Step 5.1: Compile resources (aapt2) (.flat files created), if app/src/main/res/**/*.xml is used and folders just contain images, then the images might not be correct included
          #           Use: --dir app/src/main/res: Alternative: app/src/main/res/**/* or app/src/main/res/**/*.xml app/src/main/res/**/*.png
          #                --no-crunch: Do not compress png files
          #           Result: drawable/mipmap-<xyz>_filename.flat and values_filename.arsc.flat
          #                         -o: When the path is an existing folder, then the .flat will be placed there, if it is not an existing folder then the last note is the name of the zip file, which contains the .flat files (This applies also when the last node is a filename.zip)
          # aapt2 compile -o build/res --dir app/src/main/res
          aapt2 compile --no-crunch -o build/res --dir app/src/main/res

          # Step 5.2: Create .ap_ over linkage (aapt2) with "android.jar"
          #           This also "compiles" the "AndroidManifest.xml" into the file
          #           --java build/res: Creates the "R.java" inside "build/res/package_name"
          #           --output-to-dir: With this parameter, when -o is not a file and a directory instead, it would write the files there, which would have been otherwise in the file
          aapt2 link --min-sdk-version 34 --target-sdk-version 34 -o build/res/resources.ap_ -I $ANDROID_HOME/platforms/android-34/android.jar --manifest app/src/main/AndroidManifest.xml --java build/res build/res/*

          # Step 5.3: Compile code with kotlinc (-d build/classes creates .class file for each .kt/.java file in build/classes, -d build/classes.jar creates a classes.jar that contains all .class files, -cp = -classpath)
          #           It is mandatory to pass the R.java!
          #           Note: Path preserve! If a file from "com/ownsony/adaptivebrightnesstile" is compiled and the -d is "build" the file will be in build/com/ownsony/adaptivebrightnesstile/*.class
          #           -d: Can be a .jar file or folder
          # kotlinc -d build/classes.jar app/src/main/java/com/ownsony/adaptivebrightnesstile/*.kt build/res/com/ownsony/adaptivebrightnesstile/R.java -cp $ANDROID_HOME/platforms/android-36/android.jar # app/src/main/java/com/ownsony/adaptivebrightnesstile/*.java
          kotlinc -d build/classes.jar app/src/main/java/com/xcodeapps/autobrightnesstile/*.kt build/res/com/xcodeapps/autobrightnesstile/R.java -cp $ANDROID_HOME/platforms/android-34/android.jar

          # Step 5.4: Compile Java code(.class/.jar) (d8 tool) to a single classes.dex file (When a path is given a single class.dex file will be created, otherwise it can contain .zip or .jar and will pack the single created classes.dex into the .zip or .jar)
          d8 build/classes.jar --lib $ANDROID_HOME/platforms/android-34/android.jar --output build

          # Step 5.5: Add classes.dex into resources.ap_ (aapt)
          cd build
          aapt add res/resources.ap_ classes.dex
          cd ..

          # Step 5.6: Align the APK (zipalign)
          #           When apksigner used, zipalign needs to be used BEFORE it. When jarsigner is used, zipalign needs to be used AFTER it
          zipalign -v 4 build/res/resources.ap_ build/unsigned.apk

          # Step 5.7: Decode the keystore from base64 and save it as a file
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 --decode > own-release-key.jks

          # Step 5.8: Sign the APK (apksigner)
          apksigner sign --ks own-release-key.jks --ks-key-alias ${{ secrets.KEY_ALIAS }} --ks-pass pass:${{ secrets.KEYSTORE_PASSWORD }} --key-pass pass:${{ secrets.KEY_PASSWORD }} build/unsigned.apk
          mv build/unsigned.apk build/release.apk

      # Step 5: Upload Release APK to GitHub Releases
      - name: Create Release and Upload APK
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v1.0.0
          files: build/release.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub token to authenticate and create the release
